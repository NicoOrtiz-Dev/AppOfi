<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marcador • App de Partidos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --primary-color:#1d4ed8;
      --secondary-color:#0ea5e9;
      --accent-color:#22c55e;
      --danger:#ef4444;
      --bg:#f5f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --radius:14px;
      --shadow:0 10px 30px rgba(2,6,23,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    nav{display:flex;gap:10px;background:#fff;padding:8px;border-radius:14px;box-shadow:var(--shadow);position:sticky;top:8px;z-index:2}
    .nav-btn{border:0;background:#eef2ff;color:#334155;padding:10px 14px;border-radius:12px;cursor:pointer;display:flex;gap:8px;align-items:center;font-weight:700}
    .nav-btn.active{background:var(--primary-color);color:#fff}
    main{margin-top:14px}
    .section{display:none}
    .section.active{display:block}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:14px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .section-header h2{margin:0;font-size:26px;color:var(--primary-color)}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab-btn{border:0;background:#eef2ff;color:#334155;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}
    .tab-btn.active{background:var(--secondary-color);color:#fff}
    .row{display:flex;gap:14px;align-items:center;justify-content:space-between}
    .team{display:flex;gap:8px;align-items:center}
    .team-shield{width:48px;height:48px;border-radius:50%;object-fit:cover}
    .score{font-size:28px;font-weight:800}
    .score .dash{margin:0 6px}
    .meta{display:flex;gap:8px;color:var(--muted);font-weight:700;font-size:12px}
    .btn{border:0;background:#e2e8f0;color:#0f172a;font-weight:700;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-secondary{background:var(--secondary-color);color:#fff}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .center{text-align:center}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .timer{font-size:36px;font-weight:900;color:var(--secondary-color);text-align:center;margin:8px 0}
    .timer-controls{display:flex;justify-content:center;gap:8px;margin:6px 0}
    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;justify-content:center;align-items:center;z-index:50}
    .modal{background:#fff;width:95%;max-width:900px;border-radius:16px;box-shadow:var(--shadow);padding:18px}
    .modal h3{margin:0 0 10px 0;color:var(--primary-color)}
    .event-col{background:#f1f5f9;border-radius:12px;padding:12px;min-height:220px}
    .event{background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:var(--shadow);animation:fade .25s ease}
    @keyframes fade{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <button class="nav-btn active" data-section="inicio"><i class="fa-solid fa-home"></i><span>Inicio</span></button>
      <button class="nav-btn" data-section="fechas"><i class="fa-solid fa-calendar-days"></i><span>Fechas</span></button>
      <button class="nav-btn" data-section="partidos"><i class="fa-solid fa-trophy"></i><span>Partidos</span></button>
      <button class="nav-btn" data-section="admin"><i class="fa-solid fa-user-shield"></i><span>Admin</span></button>
    </nav>

    <main>
      <!-- INICIO -->
      <section id="inicio" class="section active">
        <div class="card">
          <div class="section-header">
            <h2>Partidos en Vivo</h2>
            <i class="fa-solid fa-futbol" style="font-size:26px;color:var(--secondary-color)"></i>
          </div>
          <div id="live-container" class="grid"></div>
          <div id="no-live" class="center muted">Cargando partidos en vivo…</div>
        </div>
      </section>

      <!-- FECHAS -->
      <section id="fechas" class="section">
        <div class="card">
          <div class="section-header">
            <h2>Fechas</h2>
            <i class="fa-solid fa-calendar-check" style="font-size:26px;color:var(--secondary-color)"></i>
          </div>
          <div class="tabs">
            <button class="tab-btn active" data-tab="fechas-tab">Fechas</button>
            <button class="tab-btn" data-tab="torneos-tab">Torneos</button>
            <button class="tab-btn" data-tab="copa-tab">Copa Juvenil</button>
          </div>
          <div id="fechas-tab" class="tab card" style="box-shadow:none;padding:0">
            <div id="scheduled-container" class="grid"></div>
          </div>
          <div id="torneos-tab" class="tab card hidden" style="box-shadow:none;padding:0">
            <div id="torneos-container" class="grid"></div>
          </div>
          <div id="copa-tab" class="tab card hidden" style="box-shadow:none;padding:0">
            <div id="copa-container" class="grid"></div>
          </div>
        </div>
      </section>

      <!-- PARTIDOS FINALIZADOS -->
      <section id="partidos" class="section">
        <div class="card">
          <div class="section-header">
            <h2>Partidos Finalizados</h2>
            <i class="fa-solid fa-flag-checkered" style="font-size:26px;color:var(--accent-color)"></i>
          </div>
          <div id="finished-container" class="grid"></div>
          <div id="no-finished" class="center muted">Cargando…</div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="section">
        <div class="card">
          <div class="section-header"><h2>Admin</h2><i class="fa-solid fa-lock"></i></div>
          <div class="grid grid-2">
            <div class="card" style="margin:0">
              <h3>Crear partido</h3>
              <div class="grid grid-2">
                <input id="home-team" class="btn" placeholder="Equipo 1">
                <input id="away-team" class="btn" placeholder="Equipo 2">
                <input id="league" class="btn" placeholder="Sección (Torneo / Copa)">
                <input id="date" class="btn" type="datetime-local" placeholder="Fecha">
                <select id="stage" class="btn">
                  <option value="Fase de grupos">Fase de grupos</option>
                  <option value="Octavos de final">Octavos de final</option>
                  <option value="Cuartos de final">Cuartos de final</option>
                  <option value="Semifinal">Semifinal</option>
                  <option value="Final">Final</option>
                </select>
                <select id="type" class="btn">
                  <option value="Partido único">Partido único</option>
                  <option value="Ida">Ida</option>
                  <option value="Vuelta">Vuelta</option>
                </select>
                <input id="pre-score" class="btn" placeholder="Premarcadores (ej: 1-1)">
              </div>
              <p class="muted" style="margin-top:6px">
                <b>Premarcadores:</b> marcador global si la llave ya trae resultado previo (por ejemplo 1‑1). 
                <b>Sección:</b> en qué bloque saldrá el partido (Torneos o Copa Juvenil).
              </p>
              <button id="create" class="btn btn-primary">Crear partido</button>
            </div>
            <div class="card" style="margin:0">
              <h3>Partidos agendados</h3>
              <div id="admin-scheduled" class="grid"></div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL DE EVENTOS / CONTROL -->
  <div id="events-overlay" class="overlay">
    <div class="modal">
      <div class="row">
        <h3>Eventos del Partido</h3>
        <button id="close-events" class="btn">Cerrar</button>
      </div>
      <div id="control-meta" class="meta" style="margin-bottom:6px"></div>
      <div class="timer" id="control-timer">00:00</div>
      <div class="timer-controls">
        <button id="btn-start" class="btn btn-secondary">Reanudar</button>
        <button id="btn-pause" class="btn">Pausar</button>
        <button id="btn-half" class="btn">Descanso</button>
        <button id="btn-suspend" class="btn btn-danger">Suspender</button>
        <button id="btn-finish" class="btn btn-danger">Finalizar</button>
      </div>
      <div class="row">
        <div style="flex:1" class="event-col">
          <div class="row" style="justify-content:center;margin-bottom:8px"><b id="team1-title">Equipo 1</b></div>
          <div class="grid grid-2">
            <button class="btn add-event" data-type="gol" data-team="1">Gol</button>
            <button class="btn add-event" data-type="tiro-libre" data-team="1">Tiro libre</button>
            <button class="btn add-event" data-type="penal" data-team="1">Penal</button>
            <button class="btn add-event" data-type="travesano" data-team="1">Travesaño</button>
            <button class="btn add-event" data-type="errado" data-team="1">Errado</button>
            <button class="btn add-event" data-type="cambio" data-team="1">Cambio</button>
            <button class="btn add-event" data-type="lesion" data-team="1">Lesión</button>
            <button class="btn add-event" data-type="tarjeta-amarilla" data-team="1">T. amarilla</button>
            <button class="btn add-event" data-type="tarjeta-roja" data-team="1">T. roja</button>
          </div>
          <div id="team1-events" style="margin-top:10px"></div>
        </div>
        <div style="flex:1" class="event-col">
          <div class="row" style="justify-content:center;margin-bottom:8px"><b id="team2-title">Equipo 2</b></div>
          <div class="grid grid-2">
            <button class="btn add-event" data-type="gol" data-team="2">Gol</button>
            <button class="btn add-event" data-type="tiro-libre" data-team="2">Tiro libre</button>
            <button class="btn add-event" data-type="penal" data-team="2">Penal</button>
            <button class="btn add-event" data-type="travesano" data-team="2">Travesaño</button>
            <button class="btn add-event" data-type="errado" data-team="2">Errado</button>
            <button class="btn add-event" data-type="cambio" data-team="2">Cambio</button>
            <button class="btn add-event" data-type="lesion" data-team="2">Lesión</button>
            <button class="btn add-event" data-type="tarjeta-amarilla" data-team="2">T. amarilla</button>
            <button class="btn add-event" data-type="tarjeta-roja" data-team="2">T. roja</button>
          </div>
          <div id="team2-events" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="grid grid-2">
          <input id="player-name" class="btn" placeholder="Nombre del jugador">
          <input id="player-number" class="btn" placeholder="Dorsal (#)">
        </div>
        <input id="reason" class="btn hidden" placeholder="Motivo de suspensión">
        <p class="muted" style="margin:6px 0 0">Los eventos recientes aparecen arriba. Goles actualizan el marcador automático.</p>
      </div>
    </div>
  </div>

  <!-- Firebase imports (NO tocar endpoints) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variables globales provistas por tu entorno (no las cambiamos)
    const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : (typeof window.firebaseConfig !== 'undefined' ? window.firebaseConfig : {});

    let app, db, auth, uid = null;
    let currentMatchId = null;
    let timerState = 'stopped', timerOffset = 0, timerStart = 0, timerInterval = null;

    // ---------- UI helpers ----------
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    function show(id){ $(id).classList.remove('hidden') }
    function hide(id){ $(id).classList.add('hidden') }

    // Navigation
    $$('.nav-btn').forEach(b=>b.addEventListener('click',()=>{
      $$('.nav-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      $$('.section').forEach(s=>s.classList.remove('active'));
      $('#'+b.dataset.section).classList.add('active');
    }));

    // Tabs in "Fechas"
    $$('.tab-btn').forEach(btn=>btn.addEventListener('click',()=>{
      $$('.tab-btn').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      ['#fechas-tab','#torneos-tab','#copa-tab'].forEach(id=>{ $(id).classList.add('hidden') });
      $('#'+btn.dataset.tab).classList.remove('hidden');
    }));

    // ---------- Firebase init (NO se toca) ----------
    function init(){
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      onAuthStateChanged(auth, async (u)=>{
        if(!u) await signInAnonymously(auth);
        uid = (u||{}).uid || null;
        startListeners();
      });
    }

    // ---------- Listeners ----------
    function startListeners(){
      // LIVE
      onSnapshot(query(collection(db, `artifacts/${__app_id}/public/data/matches`), where('isLive','==',true), orderBy('createdAt','desc')), snap=>{
        const list = $('#live-container'); list.innerHTML=''; let any=false;
        snap.forEach(d=>{ any=true; renderLive(d.id, d.data(), list); });
        $('#no-live').textContent = any ? '' : 'No hay partidos en vivo. Actívalo desde Fechas → Activar.';
      });

      // SCHEDULED (Fechas)
      onSnapshot(query(collection(db, `artifacts/${__app_id}/public/data/matches`), where('isLive','==',false), where('isFinished','==',false), orderBy('createdAt','desc')), snap=>{
        const sched = [], torneos=[], copa=[];
        snap.forEach(d=>{
          const m = {id:d.id, ...d.data()};
          sched.push(m);
          if((m.league||'').toLowerCase().includes('copa')) copa.push(m);
          else torneos.push(m);
        });
        renderList('#scheduled-container', sched, true);
        renderList('#torneos-container', torneos, true);
        renderList('#copa-container', copa, true);
        // Admin panel list
        const adminList = $('#admin-scheduled'); adminList.innerHTML='';
        sched.forEach(m=> adminList.appendChild(schedItem(m)));
      });

      // FINISHED
      onSnapshot(query(collection(db, `artifacts/${__app_id}/public/data/matches`), where('isFinished','==',true), orderBy('createdAt','desc')), snap=>{
        const list = $('#finished-container'); list.innerHTML=''; let any=false;
        snap.forEach(d=>{ any=true; list.appendChild(finishedCard(d.id, d.data())); });
        $('#no-finished').textContent = any ? '' : 'Aún no hay partidos finalizados.';
      });
    }

    // ---------- Rendering ----------
    function matchRow(m){
      const dateTxt = m.date ? new Date(m.date).toLocaleString() : '';
      return `
        <div class="row">
          <div class="team"><img class="team-shield" src="${m.homeTeamShield||'https://placehold.co/60x60/007BFF/fff?text=E1'}"><b>${m.homeTeam||m.team1Name||'Equipo 1'}</b></div>
          <div class="score"><span>${m.homeScore||m.score1||0}</span><span class="dash">-</span><span>${m.awayScore||m.score2||0}</span></div>
          <div class="team"><img class="team-shield" src="${m.awayTeamShield||'https://placehold.co/60x60/28A745/fff?text=E2'}"><b>${m.awayTeam||m.team2Name||'Equipo 2'}</b></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="meta">
            <span>${m.type||'Partido único'}</span>
            <span>•</span>
            <span>${m.stage||'Fase de grupos'}</span>
            ${m.preScore ? `<span>•</span><span>Global ${m.preScore}</span>` : ''}
            ${m.statusText ? `<span>•</span><span>${m.statusText}</span>` : ''}
          </div>
          <div class="meta">${dateTxt}</div>
        </div>
      `;
    }

    function scheduledCard(m){
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = matchRow(m) + `<div class="row" style="margin-top:10px"><button data-id="${m.id}" class="btn btn-primary act">Activar</button></div>`;
      el.querySelector('.act').onclick = ()=> updateMatch(m.id,{isLive:true,isFinished:false});
      return el;
    }
    function renderList(sel, arr, scheduled=false){
      const cont = $(sel); cont.innerHTML='';
      arr.forEach(m=> cont.appendChild(scheduled ? scheduledCard(m) : liveCard(m)));
      if(arr.length===0) cont.innerHTML = `<div class="center muted">Vacío</div>`;
    }

    function schedItem(m){
      const el = document.createElement('div');
      el.className='card';
      el.style.margin='0';
      el.innerHTML = matchRow(m) + `<div class="row" style="margin-top:10px"><button class="btn btn-primary">Activar</button></div>`;
      el.querySelector('button').onclick=()=> updateMatch(m.id,{isLive:true,isFinished:false});
      return el;
    }

    function liveCard(m){
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = matchRow(m) +
        `<div class="timer" id="t-${m.id}">00:00</div>
         <div class="row" style="justify-content:center">
           <button class="btn btn-secondary open" data-id="${m.id}">Activar</button>
           <button class="btn btn-danger end" data-id="${m.id}">Finalizar</button>
         </div>`;
      // Bind
      el.querySelector('.open').onclick = ()=> openControl(m.id);
      el.querySelector('.end').onclick = ()=> finishMatch(m.id);
      return el;
    }

    function finishedCard(id,m){
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = matchRow(m) + `<div class="row" style="justify-content:flex-end"><button class="btn btn-danger del" data-id="${id}">Eliminar</button></div>`;
      el.querySelector('.del').onclick = ()=> deleteMatch(id);
      return el;
    }

    // ---------- CRUD ----------
    function updateMatch(id, data){ return updateDoc(doc(db,`artifacts/${__app_id}/public/data/matches`,id), data); }
    function deleteMatch(id){ return deleteDoc(doc(db,`artifacts/${__app_id}/public/data/matches`,id)); }
    async function finishMatch(id){
      await updateMatch(id,{isLive:false,isFinished:true,timerState:'stopped'});
      if(currentMatchId===id) stopTimerUI();
    }

    // Crear partido
    $('#create').onclick = async ()=>{
      const homeTeam=$('#home-team').value.trim();
      const awayTeam=$('#away-team').value.trim();
      const league=$('#league').value.trim();
      const date=$('#date').value;
      const stage=$('#stage').value;
      const type=$('#type').value;
      const preScore=$('#pre-score').value.trim();
      if(!homeTeam||!awayTeam||!date){ alert('Completa Equipo 1, Equipo 2 y Fecha.'); return; }
      await addDoc(collection(db,`artifacts/${__app_id}/public/data/matches`),{
        homeTeam,awayTeam,league,date,stage,type,preScore,
        homeScore:0,awayScore:0,isLive:false,isFinished:false,
        createdAt:serverTimestamp(),adminId:uid||'',
        timerState:'stopped',timerOffset:0,statusText:''
      });
      $('#home-team').value=$('#away-team').value=$('#league').value=$('#pre-score').value='';
    };

    // ---------- Control & eventos ----------
    function openControl(id){ currentMatchId=id; $('#events-overlay').style.display='flex'; syncControlHeader(); }
    $('#close-events').onclick = ()=> $('#events-overlay').style.display='none';

    async function syncControlHeader(){
      const ref = doc(db,`artifacts/${__app_id}/public/data/matches`,currentMatchId);
      const snap = await getDoc(ref); if(!snap.exists()) return;
      const m = snap.data();
      $('#team1-title').textContent = m.homeTeam;
      $('#team2-title').textContent = m.awayTeam;
      $('#control-meta').innerHTML = `${m.type||''} • ${m.stage||''}`;
      // timer display for modal mirrors live card
      startTimerUI(m);
      // subscribe events list (order desc recent first)
      onSnapshot(query(collection(db,`artifacts/${__app_id}/public/data/matches/${currentMatchId}/events`), orderBy('timestamp','desc')), snap=>{
        const a=[], b=[];
        snap.forEach(d=>{
          const e=d.data();
          const html = `<div class="event"><b>${e.label}</b><div class="muted" style="font-size:12px">${new Date(e.timestamp.toMillis?e.timestamp.toMillis():e.timestamp).toLocaleTimeString()}</div></div>`;
          (e.teamId===1?a:b).push(html);
        });
        $('#team1-events').innerHTML = a.join('');
        $('#team2-events').innerHTML = b.join('');
      });
    }

    // Event buttons
    $$('.add-event').forEach(b=>b.addEventListener('click',async ()=>{
      if(!currentMatchId) return;
      const type=b.dataset.type, teamId=+b.dataset.team;
      const name=$('#player-name').value.trim();
      const num=$('#player-number').value.trim();
      // Eventos que exigen nombre/dorsal
      const needPlayer = ['gol','cambio','tiro-libre','penal','errado','lesion'].includes(type);
      if(needPlayer && !name){ alert('Ingresa nombre del jugador.'); return; }
      const label = buildEventLabel(type, teamId, name, num);
      await addDoc(collection(db,`artifacts/${__app_id}/public/data/matches/${currentMatchId}/events`),{
        type,teamId,label,timestamp:serverTimestamp()
      });
      // marcador en goles
      if(type==='gol'){
        const ref = doc(db,`artifacts/${__app_id}/public/data/matches`,currentMatchId);
        const s = await getDoc(ref); if(s.exists()){
          const m=s.data();
          await updateDoc(ref,{ [teamId===1?'homeScore':'awayScore']: (teamId===1?m.homeScore:m.awayScore)+1 });
        }
      }
      $('#player-name').value=''; $('#player-number').value='';
    }));

    function buildEventLabel(type, teamId, name, num){
      const teamTxt = teamId===1 ? 'Equipo 1' : 'Equipo 2';
      const player = name ? `${name}${num? ' #'+num:''}` : '';
      switch(type){
        case 'gol': return `¡Gol de ${player} (${teamTxt})!`;
        case 'tiro-libre': return `Tiro libre para ${teamTxt}; cobrador ${player}`;
        case 'penal': return `Penal para ${teamTxt}; ejecuta ${player}`;
        case 'travesano': return `Travesaño de ${teamTxt}`;
        case 'errado': return `Ocasión errada de ${player} (${teamTxt})`;
        case 'cambio': return `Cambio en ${teamTxt}: ${player}`;
        case 'lesion': return `Lesión de ${player} (${teamTxt})`;
        case 'tarjeta-amarilla': return `Tarjeta amarilla para ${player} (${teamTxt})`;
        case 'tarjeta-roja': return `Tarjeta roja para ${player} (${teamTxt})`;
        default: return `${type} (${teamTxt})`;
      }
    }

    // Timer controls
    function startTimerUI(m){
      timerOffset = m.timerOffset||0;
      const state = m.timerState||'stopped';
      if(state==='running'){ timerStart=Date.now()-timerOffset; run(); }
      else { stopLoop(); $('#control-timer').textContent=format(timerOffset); }
    }
    function format(ms){ const s=Math.floor(ms/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; }
    function tick(){
      const elapsed = Date.now()-timerStart;
      $('#control-timer').textContent = format(elapsed);
      const tEl = document.querySelector(`#t-${currentMatchId}`);
      if(tEl) tEl.textContent = format(elapsed);
    }
    function run(){ stopLoop(); timerStart=Date.now()-timerOffset; timerInterval=setInterval(tick,1000); }
    function stopLoop(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } }
    function pause(){ timerOffset = Date.now()-timerStart; stopLoop(); saveTimer('paused'); }
    function resume(){ run(); saveTimer('running'); }
    function stopTimerUI(){ timerOffset=0; stopLoop(); saveTimer('stopped'); $('#control-timer').textContent='00:00'; }

    async function saveTimer(state){
      if(!currentMatchId) return;
      await updateMatch(currentMatchId,{ timerState:state, timerOffset: state==='running' ? (Date.now()-timerStart) : timerOffset });
    }

    $('#btn-start').onclick = ()=> resume();
    $('#btn-pause').onclick = ()=> pause();
    $('#btn-half').onclick = async ()=>{ pause(); await updateMatch(currentMatchId,{ statusText:`Descanso ${Math.floor((timerOffset/1000)/60)}'` }); };
    $('#btn-suspend').onclick = async ()=>{
      const reason = prompt('Motivo de la suspensión?'); if(!reason) return;
      pause(); await updateMatch(currentMatchId,{ statusText:`Suspendido: ${reason}` });
      $('#reason').classList.remove('hidden'); $('#reason').value=reason;
    };
    $('#btn-finish').onclick = async ()=>{ await finishMatch(currentMatchId); $('#events-overlay').style.display='none'; };

    // ---------- Init ----------
    init();
  </script>
</body>
</html>
