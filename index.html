<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Oficial B17 - Full Actualizado</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Incluir el archivo de configuraciÃ³n de Firebase -->
    <script type="module" src="./firebase-config.js"></script>

    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #28A745;
            --accent-color: #FFC107;
            --light-bg: #F8F9FA;
            --card-bg: #E9ECEF;
            --text-color: #212529;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
            --modal-bg: #fff;
            --modal-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --event-gold: #FFD700;
            --event-red: #DC3545;
            --event-yellow: #FFC107;
            --event-blue: #007BFF;
            --event-change: #6C757D;
            --event-injury: #FF5722;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #E9F0F4 0%, #F8F9FA 100%);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        nav {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            box-shadow: var(--box-shadow);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }

        .nav-btn i {
            font-size: 1.2em;
        }

        .section {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 2em;
            color: var(--primary-color);
            margin: 0;
        }
        
        h3 {
            font-size: 1.5em;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 15px;
        }

        .login-form {
            text-align: center;
            padding: 40px;
        }

        .login-form input {
            width: 80%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 20px;
        }

        .login-form input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .btn {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn.red {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }
        
        .btn.red:hover {
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
        }

        .live-match-card {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--box-shadow);
        }

        .match-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            text-align: center;
            position: relative;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .team-shield {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 50%;
            border: 2px solid var(--text-color);
        }

        .team-name {
            font-size: 1.2em;
            font-weight: 700;
        }

        .score-container {
            font-size: 2.5em;
            font-weight: 900;
            color: var(--primary-color);
            position: relative;
            z-index: 1;
        }
        
        .score-container::before {
            content: '-';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            color: var(--text-color);
            font-weight: 400;
        }

        .match-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: rgba(0, 0, 0, 0.7);
        }
        
        .match-details .date, .match-details .section-name {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-controls, .card-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .score-controls .btn, .card-controls .btn {
            font-size: 1.5em;
            padding: 10px 20px;
        }

        .event-log {
            background-color: #F0F2F5;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #D1D9E6;
        }
        .event-log::-webkit-scrollbar { width: 8px; }
        .event-log::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 4px; }
        .event-log::-webkit-scrollbar-track { background-color: rgba(0, 0, 0, 0.1); }

        .tab-container {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 8px;
        }

        .tab-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }
        
        .upcoming-match-card {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .upcoming-match-card .match-header {
            justify-content: space-between;
        }

        .upcoming-match-card .match-details {
            justify-content: space-between;
        }

        .admin-only-btn {
            background: #FF5722;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .admin-only-btn:hover {
            background: #E64A19;
            transform: scale(1.05);
        }

        .form-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #D1D9E6;
            background-color: white;
            color: var(--text-color);
            font-size: 16px;
            resize: none;
        }
        
        .form-group select option {
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .match-stats-card {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .stats-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-event-content {
            background-color: var(--card-bg);
            max-width: 600px;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            font-size: 1em;
            padding: 10px 20px;
        }

        .match-event-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-input-group input {
            flex: 1;
        }

        .player-input-group .btn {
            padding: 8px 12px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .nav-btn span {
                display: none;
            }
        }

        .match-timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
            background-color: var(--primary-color);
            border-radius: 8px;
            padding: 5px 10px;
            margin: 0 auto;
            width: fit-content;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .match-status {
            font-size: 1em;
            font-weight: 600;
            color: #fff;
            background-color: var(--accent-color);
            border-radius: 8px;
            padding: 5px 10px;
            margin-top: 10px;
            text-align: center;
        }

        .event-modal-teams {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 20px;
        }

        .event-modal-team-events {
            flex: 1;
        }

        .event-item {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: eventSlideIn 0.5s ease-out;
        }

        @keyframes eventSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .event-icon {
            font-size: 1.5em;
            width: 25px;
            text-align: center;
        }
        .event-text {
            font-size: 0.9em;
            flex: 1;
        }
        .event-time {
            font-size: 0.8em;
            font-style: italic;
            color: #6c757d;
        }
        
        .suspended-status {
            background-color: #DC3545;
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
        }
        
        .global-score {
            font-size: 0.9em;
            font-weight: bold;
            color: var(--primary-color);
        }

    </style>
</head>
<body>
    <div class="container">
        <nav>
            <button class="nav-btn active" data-section="inicio"><i class="fas fa-home"></i> <span>Inicio</span></button>
            <button class="nav-btn" data-section="fechas"><i class="fas fa-calendar-alt"></i> <span>Fechas</span></button>
            <button class="nav-btn" data-section="partidos"><i class="fas fa-trophy"></i> <span>Partidos</span></button>
            <button class="nav-btn" data-section="admin"><i class="fas fa-user-shield"></i> <span>Admin</span></button>
        </nav>
        <main id="app-content">
            <!-- SecciÃ³n de Inicio -->
            <section id="inicio" class="section">
                <div class="section-header">
                    <h2>Partidos en Vivo</h2>
                    <i class="fas fa-futbol" style="font-size: 2em; color: var(--accent-color);"></i>
                </div>
                <div id="live-matches-container">
                    <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">Cargando partidos en vivo...</p>
                </div>
            </section>
            <!-- SecciÃ³n de Fechas -->
            <section id="fechas" class="section" style="display:none;">
                <div class="section-header">
                    <h2>Partidos Agendados</h2>
                    <i class="fas fa-calendar-plus" style="font-size: 2em; color: var(--accent-color);"></i>
                </div>
                <div class="tab-container">
                    <button class="tab-btn active" data-tab="Fechas">Fechas</button>
                    <button class="tab-btn" data-tab="Torneos">Torneos</button>
                    <button class="tab-btn" data-tab="Copa Juvenil">Copa Juvenil</button>
                </div>
                <div id="upcoming-matches-container">
                    <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">Cargando partidos agendados...</p>
                </div>
            </section>
            <!-- SecciÃ³n de Partidos Finalizados -->
            <section id="partidos" class="section" style="display:none;">
                <div class="section-header">
                    <h2>Partidos Finalizados</h2>
                    <i class="fas fa-check-circle" style="font-size: 2em; color: var(--accent-color);"></i>
                </div>
                <div id="finished-matches-container">
                    <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">Cargando partidos finalizados...</p>
                </div>
            </section>
            <!-- SecciÃ³n de Admin -->
            <section id="admin" class="section" style="display:none;">
                <div id="admin-login" class="login-form">
                    <h2>Acceso de Administrador</h2>
                    <input type="password" id="admin-password" placeholder="ContraseÃ±a de Admin">
                    <button id="login-btn" class="btn">Acceder</button>
                </div>
                <div id="admin-panel" style="display:none;">
                    <h2>Panel de AdministraciÃ³n</h2>
                    <div class="form-container">
                        <h3>AÃ±adir Nuevo Partido</h3>
                        <div class="form-group">
                            <label for="team1-name">Nombre del Equipo 1</label>
                            <input type="text" id="team1-name" placeholder="Ej: Real Madrid">
                        </div>
                        <div class="form-group">
                            <label for="team1-shield">Escudo del Equipo 1 (URL)</label>
                            <input type="text" id="team1-shield" placeholder="Ej: https://...">
                        </div>
                        <div class="form-group">
                            <label for="team2-name">Nombre del Equipo 2</label>
                            <input type="text" id="team2-name" placeholder="Ej: Barcelona">
                        </div>
                        <div class="form-group">
                            <label for="team2-shield">Escudo del Equipo 2 (URL)</label>
                            <input type="text" id="team2-shield" placeholder="Ej: https://...">
                        </div>
                        <div class="form-group">
                            <label for="match-date">Fecha del Partido</label>
                            <input type="date" id="match-date">
                        </div>
                        <div class="form-group">
                            <label for="match-time">Hora del Partido</label>
                            <input type="time" id="match-time">
                        </div>
                        <div class="form-group">
                            <label for="match-type">Tipo de Partido</label>
                            <select id="match-type">
                                <option value="Fechas">Fechas</option>
                                <option value="Torneos">Torneos</option>
                                <option value="Copa Juvenil">Copa Juvenil</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="match-stage">Etapa del Torneo</label>
                            <select id="match-stage">
                                <option value="Fase de Grupos">Fase de Grupos</option>
                                <option value="Octavos de Final">Octavos de Final</option>
                                <option value="Cuartos de Final">Cuartos de Final</option>
                                <option value="Semifinal">Semifinal</option>
                                <option value="Final">Final</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="match-leg">Tipo de Vuelta</label>
                            <select id="match-leg">
                                <option value="Ida">Ida</option>
                                <option value="Vuelta">Vuelta</option>
                                <option value="Partido Ãnico">Partido Ãnico</option>
                            </select>
                        </div>
                        <div class="form-group" id="global-score-group" style="display: none;">
                            <label for="global-score">Marcador Global del Partido de Ida (Ej: 2-1)</label>
                            <input type="text" id="global-score" placeholder="Ej: 2-1">
                        </div>
                        <button id="add-match-btn" class="btn">AÃ±adir Partido</button>
                    </div>
                    
                    <div id="admin-events-panel">
                        <h3>Eventos del Partido</h3>
                        <p>Selecciona un partido para agregar eventos.</p>
                        <div id="admin-match-events-container"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para Mensajes -->
    <div id="message-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="message-modal-title"></h3>
            <p id="message-modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-close-btn" class="btn">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de ConfirmaciÃ³n -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-modal-title"></h3>
            <p id="confirm-modal-message"></p>
            <div class="modal-buttons">
                <button id="confirm-cancel-btn" class="btn red">Cancelar</button>
                <button id="confirm-ok-btn" class="btn">Aceptar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Eventos -->
    <div id="events-modal" class="modal-overlay">
        <div class="modal-content modal-event-content">
            <h3 id="events-modal-title">Eventos del Partido</h3>
            <div class="event-modal-teams">
                <div class="event-modal-team-events" id="events-team1">
                    <h4></h4>
                    <div id="events-list-team1"></div>
                </div>
                <div class="event-modal-team-events" id="events-team2">
                    <h4></h4>
                    <div id="events-list-team2"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="events-modal-close-btn" class="btn">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Controles de Partido -->
    <div id="control-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="control-modal-title">Controles de Partido</h3>
            <div class="form-container">
                <div class="form-group">
                    <label for="timer-action">Control de Tiempo</label>
                    <select id="timer-action">
                        <option value="start">Iniciar/Reanudar</option>
                        <option value="pause">Pausa/Descanso</option>
                        <option value="suspend">Suspender</option>
                    </select>
                </div>
                <div class="form-group" id="suspension-reason-group" style="display:none;">
                    <label for="suspension-reason">Motivo de la SuspensiÃ³n</label>
                    <textarea id="suspension-reason" placeholder="Ej: Lluvia intensa, falta de energÃ­a, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label>AÃ±adir Evento</label>
                    <div class="player-input-group">
                        <select id="event-type">
                            <option value="">Seleccionar Evento</option>
                            <option value="Gol">Gol</option>
                            <option value="Tiro libre">Tiro libre</option>
                            <option value="Penal">Penal</option>
                            <option value="TravesaÃ±o">TravesaÃ±o</option>
                            <option value="Errado">Errado</option>
                            <option value="Cambio">Cambio</option>
                            <option value="Lesion">LesiÃ³n</option>
                            <option value="Tarjeta amarilla">Tarjeta amarilla</option>
                            <option value="Tarjeta roja">Tarjeta roja</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group" id="event-details-group" style="display:none;">
                        <label for="event-team">Equipo</label>
                        <select id="event-team"></select>
                        <label for="event-player-name">Nombre del Jugador</label>
                        <input type="text" id="event-player-name" placeholder="Nombre completo">
                        <label for="event-player-number">NÃºmero de Dorsal</label>
                        <input type="text" id="event-player-number" placeholder="Ej: 10">
                        <label for="event-description">DescripciÃ³n (Opcional)</label>
                        <input type="text" id="event-description" placeholder="Ej: Anotado de cabeza">
                    </div>
                </div>
                <button id="add-event-btn" class="btn">AÃ±adir Evento</button>
                <button id="end-match-btn" class="btn red">Finalizar Partido</button>
            </div>
            <div class="modal-buttons">
                <button id="control-close-btn" class="btn">Cerrar</button>
            </div>
        </div>
    </div>
    
    <div id="loader" class="spinner"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales proporcionadas por el entorno del Canvas
        const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const __firebase_config = typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey": "YOUR_API_KEY", "authDomain": "YOUR_AUTH_DOMAIN", "projectId": "YOUR_PROJECT_ID", "storageBucket": "YOUR_STORAGE_BUCKET", "messagingSenderId": "YOUR_MESSAGING_SENDER_ID", "appId": "YOUR_APP_ID"}';
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- ConfiguraciÃ³n e InicializaciÃ³n de Firebase (NO MODIFICAR) ---
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Error parsing firebase config:", e);
            firebaseConfig = {};
        }

        let app;
        let db;
        let auth;
        let userId = null;

        const initFirebase = async () => {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Authenticated as:", userId);
                            // Cargar datos despuÃ©s de la autenticaciÃ³n
                            loadData();
                        } else {
                            console.log("Not authenticated, signing in anonymously...");
                            // Si no hay token, intentar con autenticaciÃ³n anÃ³nima
                            await signInAnonymously(auth);
                        }
                    });

                    if (__initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    }
                }
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showMessage("Error de Firebase", "No se pudo conectar a la base de datos.");
            }
        };

        initFirebase();

        // --- Funciones auxiliares y de UI ---
        const showMessage = (title, message) => {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-message').textContent = message;
            document.getElementById('message-modal').style.display = 'flex';
        };

        const showModal = (type, title, message, onConfirm) => {
            if (type === 'confirm') {
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-message').textContent = message;
                document.getElementById('confirm-ok-btn').onclick = onConfirm;
                document.getElementById('confirm-modal').style.display = 'flex';
            } else if (type === 'control') {
                document.getElementById('control-modal-title').textContent = title;
                document.getElementById('control-modal').style.display = 'flex';
            } else if (type === 'events') {
                document.getElementById('events-modal-title').textContent = title;
                document.getElementById('events-modal').style.display = 'flex';
            }
        };

        const hideModal = (type) => {
            if (type === 'message') {
                document.getElementById('message-modal').style.display = 'none';
            } else if (type === 'confirm') {
                document.getElementById('confirm-modal').style.display = 'none';
            } else if (type === 'control') {
                document.getElementById('control-modal').style.display = 'none';
            } else if (type === 'events') {
                document.getElementById('events-modal').style.display = 'none';
            }
        };
        
        const showLoader = () => { document.getElementById('loader').style.display = 'block'; };
        const hideLoader = () => { document.getElementById('loader').style.display = 'none'; };

        // --- Variables y Estado ---
        let currentLiveMatchId = null;
        let matchTimerInterval = null;
        let timerStartTime = 0;
        let isTimerRunning = false;
        let suspensionReason = '';

        // --- Funciones para la UI ---
        const switchSection = (sectionId) => {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
        };
        
        const renderLiveMatches = (matches) => {
            const container = document.getElementById('live-matches-container');
            container.innerHTML = '';
            if (matches.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(0, 0, 0, 0.5);">No hay partidos en vivo en este momento.</p>';
            } else {
                matches.forEach(match => {
                    const matchCard = document.createElement('div');
                    matchCard.className = 'live-match-card';
                    matchCard.dataset.matchId = match.id;
                    matchCard.innerHTML = `
                        <div class="match-header">
                            <div class="team">
                                <img src="${match.team1Shield}" onerror="this.src='https://placehold.co/60x60/e9ecef/212529?text=E1'" alt="Escudo Equipo 1" class="team-shield">
                                <span class="team-name">${match.team1Name}</span>
                            </div>
                            <div class="score-container">
                                <span id="score1-${match.id}">${match.score1}</span>
                                <span id="score2-${match.id}">${match.score2}</span>
                            </div>
                            <div class="team">
                                <img src="${match.team2Shield}" onerror="this.src='https://placehold.co/60x60/e9ecef/212529?text=E2'" alt="Escudo Equipo 2" class="team-shield">
                                <span class="team-name">${match.team2Name}</span>
                            </div>
                        </div>
                        <div class="match-details" id="match-details-${match.id}">
                            <span class="section-name" style="background-color: var(--primary-color); color: white; padding: 5px 10px; border-radius: 8px;">
                                <i class="fas fa-flag"></i> ${match.matchStage}
                            </span>
                            <span class="date" style="background-color: var(--accent-color); color: black; padding: 5px 10px; border-radius: 8px;">
                                <i class="fas fa-clock"></i> <span id="match-timer-${match.id}">00:00</span>
                            </span>
                        </div>
                        <div class="match-details" id="match-info-${match.id}" style="justify-content: center; font-weight: 600;">
                           ${match.matchLeg && match.matchLeg !== 'Partido Ãnico' ? `<span id="match-leg-${match.id}">${match.matchLeg}</span>` : ''}
                        </div>
                        ${match.suspensionReason ? `<div class="suspended-status">Partido Suspendido: ${match.suspensionReason}</div>` : ''}
                        <div id="events-log-${match.id}" class="event-log" style="display:none;"></div>
                        <div class="admin-controls">
                            <div class="card-controls">
                                <button class="btn" onclick="showEventModal('${match.id}', '${match.team1Name}', '${match.team2Name}')"><i class="fas fa-list-ul"></i> Eventos</button>
                                <button class="btn red" onclick="showControlModal('${match.id}', '${match.team1Name}', '${match.team2Name}', '${match.suspensionReason}')"><i class="fas fa-cogs"></i> Controles</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(matchCard);
                });
            }
        };

        const renderUpcomingMatches = (matches, currentTab) => {
            const container = document.getElementById('upcoming-matches-container');
            container.innerHTML = '';
            const filteredMatches = matches.filter(match => match.matchType === currentTab);
            
            if (filteredMatches.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(0, 0, 0, 0.5);">No hay partidos agendados en esta secciÃ³n.</p>';
            } else {
                filteredMatches.forEach(match => {
                    const matchCard = document.createElement('div');
                    matchCard.className = 'upcoming-match-card';
                    matchCard.innerHTML = `
                        <div class="match-header">
                            <div class="team">
                                <img src="${match.team1Shield}" onerror="this.src='https://placehold.co/40x40/e9ecef/212529?text=E1'" alt="Escudo Equipo 1" class="team-shield" style="width:40px;height:40px;">
                                <span class="team-name" style="font-size:1em;">${match.team1Name}</span>
                            </div>
                            <span style="font-weight: bold;">vs</span>
                            <div class="team">
                                <img src="${match.team2Shield}" onerror="this.src='https://placehold.co/40x40/e9ecef/212529?text=E2'" alt="Escudo Equipo 2" class="team-shield" style="width:40px;height:40px;">
                                <span class="team-name" style="font-size:1em;">${match.team2Name}</span>
                            </div>
                        </div>
                        <div class="match-details">
                            <span class="date">
                                <i class="far fa-calendar-alt"></i> ${match.date}
                            </span>
                            <span class="date">
                                <i class="far fa-clock"></i> ${match.time}
                            </span>
                        </div>
                        <div class="match-details" style="justify-content: center; font-weight: 600;">
                            <span class="section-name" style="background-color: var(--primary-color); color: white; padding: 5px 10px; border-radius: 8px;">
                                <i class="fas fa-flag"></i> ${match.matchStage}
                            </span>
                            <span class="section-name" style="background-color: var(--accent-color); color: black; padding: 5px 10px; border-radius: 8px;">
                                <i class="fas fa-sync-alt"></i> ${match.matchLeg}
                            </span>
                        </div>
                        ${match.globalScore ? `<div class="match-details" style="justify-content: center;"><span class="global-score">Global: ${match.globalScore}</span></div>` : ''}
                        ${userId ? `
                        <div style="text-align:center; margin-top:10px;">
                            <button class="admin-only-btn" onclick="activateMatch('${match.id}')">Activar Partido</button>
                        </div>
                        ` : ''}
                    `;
                    container.appendChild(matchCard);
                });
            }
        };

        const renderFinishedMatches = (matches) => {
            const container = document.getElementById('finished-matches-container');
            container.innerHTML = '';
            if (matches.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(0, 0, 0, 0.5);">No hay partidos finalizados.</p>';
            } else {
                matches.forEach(match => {
                    const matchCard = document.createElement('div');
                    matchCard.className = 'upcoming-match-card';
                    matchCard.innerHTML = `
                        <div class="match-header">
                            <div class="team">
                                <img src="${match.team1Shield}" onerror="this.src='https://placehold.co/40x40/e9ecef/212529?text=E1'" alt="Escudo Equipo 1" class="team-shield" style="width:40px;height:40px;">
                                <span class="team-name" style="font-size:1em;">${match.team1Name}</span>
                            </div>
                            <div class="score-container" style="font-size: 1.5em; flex-basis: 100px;">
                                <span>${match.score1}</span><span>${match.score2}</span>
                            </div>
                            <div class="team">
                                <img src="${match.team2Shield}" onerror="this.src='https://placehold.co/40x40/e9ecef/212529?text=E2'" alt="Escudo Equipo 2" class="team-shield" style="width:40px;height:40px;">
                                <span class="team-name" style="font-size:1em;">${match.team2Name}</span>
                            </div>
                        </div>
                        <div class="match-details">
                            <span class="date">
                                <i class="far fa-calendar-alt"></i> ${match.date}
                            </span>
                            <span class="date">
                                <i class="far fa-clock"></i> ${match.time}
                            </span>
                        </div>
                        <div class="match-details" style="justify-content: center; font-weight: 600;">
                            <span class="section-name" style="background-color: var(--primary-color); color: white; padding: 5px 10px; border-radius: 8px;">
                                <i class="fas fa-flag"></i> ${match.matchStage}
                            </span>
                            <span class="section-name" style="background-color: var(--accent-color); color: black; padding: 5px 10px; border-radius: 8px;">
                                <i class="fas fa-sync-alt"></i> ${match.matchLeg}
                            </span>
                        </div>
                        ${match.globalScore ? `<div class="match-details" style="justify-content: center;"><span class="global-score">Global: ${match.globalScore}</span></div>` : ''}
                        ${userId ? `
                        <div style="text-align:center; margin-top:10px;">
                            <button class="admin-only-btn red" onclick="showConfirmModalToDelete('${match.id}')">Eliminar</button>
                        </div>
                        ` : ''}
                    `;
                    container.appendChild(matchCard);
                });
            }
        };

        const updateTimerDisplay = (elapsedTime) => {
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = Math.floor(elapsedTime % 60);
            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (currentLiveMatchId) {
                const timerSpan = document.getElementById(`match-timer-${currentLiveMatchId}`);
                if (timerSpan) {
                    timerSpan.textContent = formattedTime;
                }
            }
        };

        const startTimer = (startTime) => {
            if (isTimerRunning) return;
            isTimerRunning = true;
            timerStartTime = startTime;
            matchTimerInterval = setInterval(() => {
                const currentTime = Date.now();
                const elapsedSeconds = Math.floor((currentTime - timerStartTime) / 1000);
                updateTimerDisplay(elapsedSeconds);
            }, 1000);
        };

        const pauseTimer = () => {
            clearInterval(matchTimerInterval);
            isTimerRunning = false;
        };

        // --- Funciones de Firebase (NO MODIFICAR) ---
        const updateMatchState = async (matchId, data, eventDesc = null) => {
            if (!db) { showMessage("Error", "La base de datos no estÃ¡ disponible."); return; }
            try {
                const matchRef = doc(db, 'artifacts', __app_id, 'matches', matchId);
                const updateData = { ...data };
                if (eventDesc) {
                    const eventData = {
                        description: eventDesc,
                        timestamp: new Date(),
                    };
                    await addDoc(collection(matchRef, 'events'), eventData);
                }
                await updateDoc(matchRef, updateData);
            } catch (e) {
                console.error("Error updating document:", e);
                showMessage("Error", "Error al actualizar el partido. Intenta de nuevo.");
            }
        };

        const addMatchToDB = async (matchData) => {
            if (!db) { showMessage("Error", "La base de datos no estÃ¡ disponible."); return; }
            showLoader();
            try {
                await addDoc(collection(db, 'artifacts', __app_id, 'matches'), matchData);
                showMessage("Ãxito", "Partido aÃ±adido correctamente.");
            } catch (e) {
                console.error("Error adding document:", e);
                showMessage("Error", "Error al aÃ±adir el partido. Intenta de nuevo.");
            } finally {
                hideLoader();
            }
        };
        
        const deleteMatchFromDB = async (matchId) => {
            if (!db) { showMessage("Error", "La base de datos no estÃ¡ disponible."); return; }
            showLoader();
            try {
                await deleteDoc(doc(db, 'artifacts', __app_id, 'matches', matchId));
                showMessage("Ãxito", "Partido eliminado correctamente.");
            } catch (e) {
                console.error("Error removing document:", e);
                showMessage("Error", "Error al eliminar el partido. Intenta de nuevo.");
            } finally {
                hideLoader();
            }
        };

        const getTeams = async () => {
             if (!db) { showMessage("Error", "La base de datos no estÃ¡ disponible."); return []; }
             try {
                 const teamsRef = collection(db, 'artifacts', __app_id, 'teams');
                 const q = query(teamsRef);
                 const teamsSnapshot = await getDocs(q);
                 return teamsSnapshot.docs.map(doc => doc.data());
             } catch (e) {
                 console.error("Error fetching teams:", e);
                 return [];
             }
         };

        // --- LÃ³gica de la App ---
        const loadData = () => {
            if (!db) { return; }
            
            // Listener para partidos en vivo
            const liveMatchesRef = collection(db, 'artifacts', __app_id, 'matches');
            const qLive = query(liveMatchesRef, where('isLive', '==', true));
            onSnapshot(qLive, (snapshot) => {
                const liveMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLiveMatches(liveMatches);
                if (liveMatches.length > 0) {
                    const liveMatch = liveMatches[0];
                    currentLiveMatchId = liveMatch.id;
                    if (liveMatch.isLive && liveMatch.timerStart && !liveMatch.isPaused && !liveMatch.isSuspended) {
                        startTimer(liveMatch.timerStart.toMillis());
                    } else if (liveMatch.isPaused) {
                        pauseTimer();
                        updateTimerDisplay(liveMatch.elapsedTime);
                    } else if (liveMatch.isSuspended) {
                        pauseTimer();
                        document.getElementById(`match-details-${liveMatch.id}`).style.display = 'none';
                        document.getElementById(`match-info-${liveMatch.id}`).innerHTML = `<div class="suspended-status">${liveMatch.suspensionReason}</div>`;
                    }
                    loadLiveMatchEvents(liveMatch.id);
                } else {
                    currentLiveMatchId = null;
                    pauseTimer();
                }
            });

            // Listener para partidos agendados
            const upcomingMatchesRef = collection(db, 'artifacts', __app_id, 'matches');
            const qUpcoming = query(upcomingMatchesRef, where('isLive', '==', false), where('isFinished', '==', false));
            onSnapshot(qUpcoming, (snapshot) => {
                const upcomingMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const currentTab = document.querySelector('.tab-btn.active').dataset.tab;
                renderUpcomingMatches(upcomingMatches, currentTab);
            });
            
            // Listener para partidos finalizados
            const finishedMatchesRef = collection(db, 'artifacts', __app_id, 'matches');
            const qFinished = query(finishedMatchesRef, where('isFinished', '==', true));
            onSnapshot(qFinished, (snapshot) => {
                const finishedMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFinishedMatches(finishedMatches);
            });
        };

        const loadLiveMatchEvents = (matchId) => {
            if (!db) { return; }
            const eventsRef = collection(db, 'artifacts', __app_id, 'matches', matchId, 'events');
            const qEvents = query(eventsRef, orderBy('timestamp', 'desc'));
            onSnapshot(qEvents, (snapshot) => {
                const eventLog = document.getElementById(`events-log-${matchId}`);
                if (eventLog) {
                    eventLog.innerHTML = '';
                    snapshot.docs.forEach(doc => {
                        const event = doc.data();
                        const eventItem = document.createElement('div');
                        eventItem.className = 'event-item';
                        let icon = '<i class="fas fa-futbol" style="color: var(--event-gold);"></i>';
                        switch(event.type) {
                            case 'Gol': icon = `<i class="fas fa-futbol" style="color: var(--event-gold);"></i>`; break;
                            case 'Tiro libre': icon = `<i class="fas fa-bullseye" style="color: var(--event-blue);"></i>`; break;
                            case 'Penal': icon = `<i class="fas fa-dot-circle" style="color: var(--event-blue);"></i>`; break;
                            case 'TravesaÃ±o': icon = `<i class="fas fa-minus" style="color: var(--event-blue);"></i>`; break;
                            case 'Tarjeta amarilla': icon = `<i class="fas fa-square" style="color: var(--event-yellow);"></i>`; break;
                            case 'Tarjeta roja': icon = `<i class="fas fa-square" style="color: var(--event-red);"></i>`; break;
                            case 'Cambio': icon = `<i class="fas fa-exchange-alt" style="color: var(--event-change);"></i>`; break;
                            case 'Lesion': icon = `<i class="fas fa-ambulance" style="color: var(--event-injury);"></i>`; break;
                            case 'Errado': icon = `<i class="fas fa-times-circle" style="color: #6C757D;"></i>`; break;
                            case 'Otro': icon = `<i class="fas fa-info-circle" style="color: #6C757D;"></i>`; break;
                        }
                        eventItem.innerHTML = `
                            <div class="event-icon">${icon}</div>
                            <div class="event-text"><strong>${event.type}</strong>: ${event.description}</div>
                            <div class="event-time">${event.time}</div>
                        `;
                        eventLog.appendChild(eventItem);
                    });
                    if (snapshot.docs.length > 0) {
                        eventLog.style.display = 'block';
                    }
                }
            });
        };

        window.activateMatch = async (matchId) => {
            if (!db) { showMessage("Error", "La base de datos no estÃ¡ disponible."); return; }
            showLoader();
            try {
                const matchRef = doc(db, 'artifacts', __app_id, 'matches', matchId);
                const liveMatchRef = collection(db, 'artifacts', __app_id, 'matches');
                const liveQuery = query(liveMatchRef, where('isLive', '==', true));
                const liveSnapshot = await getDocs(liveQuery);

                if (liveSnapshot.docs.length > 0) {
                    showMessage("Error", "Ya hay un partido en vivo. FinalÃ­zalo antes de activar otro.");
                    return;
                }

                await updateDoc(matchRef, {
                    isLive: true,
                    isPaused: false,
                    isSuspended: false,
                    timerStart: new Date(),
                    elapsedTime: 0,
                    score1: 0,
                    score2: 0,
                    suspensionReason: null
                });
                showMessage("Ãxito", "Â¡El partido ha sido activado!");
            } catch (e) {
                console.error("Error activating match:", e);
                showMessage("Error", "Error al activar el partido.");
            } finally {
                hideLoader();
            }
        };

        window.showConfirmModalToDelete = (matchId) => {
            showModal('confirm', 'Eliminar Partido', 'Â¿EstÃ¡s seguro de que quieres eliminar este partido de forma permanente?', async () => {
                await deleteMatchFromDB(matchId);
                hideModal('confirm');
            });
        };

        window.showEventModal = async (matchId, team1Name, team2Name) => {
            document.getElementById('events-modal-title').textContent = `Eventos: ${team1Name} vs ${team2Name}`;
            document.querySelector('#events-team1 h4').textContent = team1Name;
            document.querySelector('#events-team2 h4').textContent = team2Name;
            
            const eventsList1 = document.getElementById('events-list-team1');
            const eventsList2 = document.getElementById('events-list-team2');
            eventsList1.innerHTML = '';
            eventsList2.innerHTML = '';
            
            if (!db) { showMessage("Error", "La base de datos no estÃ¡ disponible."); return; }
            
            const eventsRef = collection(db, 'artifacts', __app_id, 'matches', matchId, 'events');
            const q = query(eventsRef, orderBy('timestamp', 'desc'));
            
            const eventsSnapshot = await getDocs(q);
            const events = eventsSnapshot.docs.map(doc => doc.data());

            events.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                let icon = '';
                let teamContainer = null;
                switch(event.type) {
                    case 'Gol': icon = `<i class="fas fa-futbol" style="color: var(--event-gold);"></i>`; break;
                    case 'Tiro libre': icon = `<i class="fas fa-bullseye" style="color: var(--event-blue);"></i>`; break;
                    case 'Penal': icon = `<i class="fas fa-dot-circle" style="color: var(--event-blue);"></i>`; break;
                    case 'TravesaÃ±o': icon = `<i class="fas fa-minus" style="color: var(--event-blue);"></i>`; break;
                    case 'Tarjeta amarilla': icon = `<i class="fas fa-square" style="color: var(--event-yellow);"></i>`; break;
                    case 'Tarjeta roja': icon = `<i class="fas fa-square" style="color: var(--event-red);"></i>`; break;
                    case 'Cambio': icon = `<i class="fas fa-exchange-alt" style="color: var(--event-change);"></i>`; break;
                    case 'Lesion': icon = `<i class="fas fa-ambulance" style="color: var(--event-injury);"></i>`; break;
                    case 'Errado': icon = `<i class="fas fa-times-circle" style="color: #6C757D;"></i>`; break;
                    case 'Otro': icon = `<i class="fas fa-info-circle" style="color: #6C757D;"></i>`; break;
                    default: icon = `<i class="fas fa-info-circle" style="color: #6C757D;"></i>`; break;
                }
                
                eventItem.innerHTML = `
                    <div class="event-icon">${icon}</div>
                    <div class="event-text">
                        <strong>${event.type}</strong>: ${event.description}
                    </div>
                    <div class="event-time">${event.time}</div>
                `;

                if (event.team === team1Name) {
                    eventsList1.appendChild(eventItem);
                } else if (event.team === team2Name) {
                    eventsList2.appendChild(eventItem);
                } else {
                    // Fallback para eventos sin equipo
                    eventsList1.appendChild(eventItem);
                }
            });

            showModal('events', 'Eventos del Partido');
        };

        window.showControlModal = async (matchId, team1Name, team2Name, suspensionReason) => {
             const matchRef = doc(db, 'artifacts', __app_id, 'matches', matchId);
             const matchSnapshot = await getDoc(matchRef);
             const matchData = matchSnapshot.data();
             
             document.getElementById('control-modal-title').textContent = `Controles: ${team1Name} vs ${team2Name}`;
             currentLiveMatchId = matchId;
             
             // Populate event teams select
             const eventTeamSelect = document.getElementById('event-team');
             eventTeamSelect.innerHTML = `<option value="">Seleccionar Equipo</option>`;
             const team1Option = document.createElement('option');
             team1Option.value = team1Name;
             team1Option.textContent = team1Name;
             eventTeamSelect.appendChild(team1Option);
             const team2Option = document.createElement('option');
             team2Option.value = team2Name;
             team2Option.textContent = team2Name;
             eventTeamSelect.appendChild(team2Option);

             // Set suspension state
             if (suspensionReason) {
                document.getElementById('timer-action').value = 'suspend';
                document.getElementById('suspension-reason-group').style.display = 'block';
                document.getElementById('suspension-reason').value = suspensionReason;
             } else {
                document.getElementById('timer-action').value = 'start';
                document.getElementById('suspension-reason-group').style.display = 'none';
                document.getElementById('suspension-reason').value = '';
             }

             showModal('control', 'Controles de Partido');
         };
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // NavegaciÃ³n
            document.querySelectorAll('.nav-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.dataset.section;
                    switchSection(sectionId);
                });
            });

            // TabulaciÃ³n de Fechas
            document.querySelectorAll('#fechas .tab-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    document.querySelectorAll('#fechas .tab-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    if (db) {
                       const upcomingMatchesRef = collection(db, 'artifacts', __app_id, 'matches');
                       const qUpcoming = query(upcomingMatchesRef, where('isLive', '==', false), where('isFinished', '==', false));
                       const snapshot = await getDocs(qUpcoming);
                       const upcomingMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                       renderUpcomingMatches(upcomingMatches, button.dataset.tab);
                    }
                });
            });

            // Administrador
            document.getElementById('login-btn').addEventListener('click', async () => {
                const password = document.getElementById('admin-password').value;
                if (password === 'admin123') {
                    document.getElementById('admin-login').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    showMessage("Ãxito", "Acceso de administrador concedido.");
                } else {
                    showMessage("Error", "ContraseÃ±a incorrecta.");
                }
            });

            // LÃ³gica de Marcador Global
            document.getElementById('match-leg').addEventListener('change', (e) => {
                if (e.target.value === 'Vuelta') {
                    document.getElementById('global-score-group').style.display = 'flex';
                } else {
                    document.getElementById('global-score-group').style.display = 'none';
                }
            });

            // AÃ±adir Partido
            document.getElementById('add-match-btn').addEventListener('click', async () => {
                const team1Name = document.getElementById('team1-name').value;
                const team1Shield = document.getElementById('team1-shield').value;
                const team2Name = document.getElementById('team2-name').value;
                const team2Shield = document.getElementById('team2-shield').value;
                const date = document.getElementById('match-date').value;
                const time = document.getElementById('match-time').value;
                const matchType = document.getElementById('match-type').value;
                const matchStage = document.getElementById('match-stage').value;
                const matchLeg = document.getElementById('match-leg').value;
                const globalScore = document.getElementById('global-score').value;

                if (!team1Name || !team2Name || !date || !time) {
                    showMessage("Error", "Por favor, completa todos los campos obligatorios.");
                    return;
                }

                const newMatch = {
                    team1Name,
                    team1Shield,
                    team2Name,
                    team2Shield,
                    date,
                    time,
                    matchType,
                    matchStage,
                    matchLeg,
                    globalScore: (matchLeg === 'Vuelta') ? globalScore : null,
                    score1: 0,
                    score2: 0,
                    isLive: false,
                    isFinished: false,
                };
                await addMatchToDB(newMatch);
            });
            
            // Event Listeners for control modal
            document.getElementById('timer-action').addEventListener('change', (e) => {
                if (e.target.value === 'suspend') {
                    document.getElementById('suspension-reason-group').style.display = 'flex';
                } else {
                    document.getElementById('suspension-reason-group').style.display = 'none';
                }
            });

            document.getElementById('add-event-btn').addEventListener('click', async () => {
                if (!currentLiveMatchId || !db) { showMessage("Error", "La base de datos no estÃ¡ disponible."); return; }
                const eventType = document.getElementById('event-type').value;
                const eventTeam = document.getElementById('event-team').value;
                const eventPlayerName = document.getElementById('event-player-name').value;
                const eventPlayerNumber = document.getElementById('event-player-number').value;
                const eventDescription = document.getElementById('event-description').value;

                if (!eventType || !eventTeam) {
                    showMessage("Error", "Por favor, selecciona un tipo de evento y un equipo.");
                    return;
                }

                const matchRef = doc(db, 'artifacts', __app_id, 'matches', currentLiveMatchId);
                const eventsCollectionRef = collection(matchRef, 'events');
                
                let eventText = '';
                if (eventType === 'Gol' || eventType === 'Cambio' || eventType === 'Lesion' || eventType === 'Tarjeta amarilla' || eventType === 'Tarjeta roja') {
                    if (!eventPlayerName) {
                        showMessage("Error", "El nombre del jugador es requerido para este evento.");
                        return;
                    }
                    eventText = `${eventPlayerName} #${eventPlayerNumber || 'N/A'}`;
                } else if (eventType === 'Tiro libre' || eventType === 'Penal') {
                    eventText = `${eventType} para ${eventTeam}`;
                    if (eventPlayerName) {
                        eventText += `; Cobrador: ${eventPlayerName} #${eventPlayerNumber || 'N/A'}`;
                    }
                } else {
                    eventText = eventDescription || eventType;
                }

                let score1 = 0;
                let score2 = 0;
                const matchSnapshot = await getDoc(matchRef);
                const matchData = matchSnapshot.data();
                if (matchData) {
                    score1 = matchData.score1 || 0;
                    score2 = matchData.score2 || 0;
                }
                
                if (eventType === 'Gol') {
                    if (eventTeam === matchData.team1Name) {
                        score1++;
                    } else {
                        score2++;
                    }
                }

                await setDoc(matchRef, { score1: score1, score2: score2 }, { merge: true });
                
                await addDoc(eventsCollectionRef, {
                    type: eventType,
                    description: eventText,
                    team: eventTeam,
                    timestamp: new Date(),
                    time: document.getElementById(`match-timer-${currentLiveMatchId}`).textContent,
                });
                showMessage("Ãxito", "Evento aÃ±adido correctamente.");
            });

            document.getElementById('end-match-btn').addEventListener('click', async () => {
                 if (!currentLiveMatchId || !db) { showMessage("Error", "La base de datos no estÃ¡ disponible."); return; }
                 showModal('confirm', 'Finalizar Partido', 'Â¿EstÃ¡s seguro de que quieres finalizar este partido? No podrÃ¡ volver a ser en vivo.', async () => {
                     await updateMatchState(currentLiveMatchId, { isLive: false, isFinished: true, elapsedTime: 0 }, 'Partido Finalizado');
                     hideModal('confirm');
                     hideModal('control');
                 });
             });
            
            // LÃ³gica para controlar el temporizador
            document.getElementById('timer-action').addEventListener('change', async (e) => {
                const action = e.target.value;
                const matchRef = doc(db, 'artifacts', __app_id, 'matches', currentLiveMatchId);
                const matchSnapshot = await getDoc(matchRef);
                const matchData = matchSnapshot.data();

                if (action === 'start') {
                    const elapsedTime = matchData.elapsedTime || 0;
                    await updateDoc(matchRef, {
                        isPaused: false,
                        isSuspended: false,
                        timerStart: new Date(Date.now() - (elapsedTime * 1000))
                    });
                } else if (action === 'pause') {
                    const elapsedTime = Math.floor((Date.now() - matchData.timerStart.toMillis()) / 1000);
                    await updateDoc(matchRef, {
                        isPaused: true,
                        isSuspended: false,
                        elapsedTime: elapsedTime
                    });
                } else if (action === 'suspend') {
                     const reason = document.getElementById('suspension-reason').value;
                     if (!reason) {
                          showMessage("Error", "Por favor, ingresa el motivo de la suspensiÃ³n.");
                          e.target.value = matchData.isPaused ? 'pause' : 'start';
                          return;
                     }
                     const elapsedTime = Math.floor((Date.now() - matchData.timerStart.toMillis()) / 1000);
                     await updateDoc(matchRef, {
                         isPaused: true,
                         isSuspended: true,
                         suspensionReason: reason,
                         elapsedTime: elapsedTime
                     });
                 }
             });

            // Controladores para los modales
            document.getElementById('modal-close-btn').addEventListener('click', () => hideModal('message'));
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => hideModal('confirm'));
            document.getElementById('control-close-btn').addEventListener('click', () => hideModal('control'));
            document.getElementById('events-modal-close-btn').addEventListener('click', () => hideModal('events'));
        });
    </script>
</body>
</html>
