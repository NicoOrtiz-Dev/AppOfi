<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Oficial B17 - Full Actualizado</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Incluir Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #28A745;
            --accent-color: #FFC107;
            --light-bg: #F8F9FA;
            --card-bg: #E9ECEF;
            --text-color: #212529;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #E9F0F4 0%, #F8F9FA 100%);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        nav {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            box-shadow: var(--box-shadow);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }

        .nav-btn i {
            font-size: 1.2em;
        }

        .section {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 2em;
            color: var(--primary-color);
            margin: 0;
        }
        
        h3 {
            font-size: 1.5em;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 15px;
        }

        .login-form {
            text-align: center;
            padding: 40px;
        }

        .login-form input {
            width: 80%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 20px;
        }

        .login-form input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .btn {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn.red {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }
        
        .btn.red:hover {
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
        }

        .live-match-card {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--box-shadow);
        }

        .match-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            text-align: center;
            position: relative;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .team-shield {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 50%;
            border: 2px solid var(--text-color);
        }

        .team-name {
            font-size: 1.2em;
            font-weight: 700;
        }
        
        /* Modificado para que el guión sea parte del marcador */
        .score-container {
            font-size: 2.5em;
            font-weight: 900;
            color: var(--primary-color);
            position: relative;
            z-index: 1;
        }

        .match-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: rgba(0, 0, 0, 0.7);
        }
        
        .match-details .date, .match-details .section-name {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Estilos para el contador de tiempo, centrado */
        .match-timer {
            text-align: center;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
        }
        
        /* Estilos para la info de etapa y partido */
        .match-info-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 5px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9em;
        }

        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-controls, .card-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .score-controls .btn, .card-controls .btn {
            font-size: 1.5em;
            padding: 10px 20px;
        }

        .event-log {
            background-color: #F0F2F5;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #D1D9E6;
            margin-top: 15px;
        }
        .event-log::-webkit-scrollbar { width: 8px; }
        .event-log::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 4px; }
        .event-log::-webkit-scrollbar-track { background-color: rgba(0, 0, 0, 0.1); }
        
        /* Estilos para los eventos del partido */
        .match-events {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .event-item {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInFromTop 0.5s ease-out;
        }

        @keyframes slideInFromTop {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .event-item.goal { background-color: #d4edda; }
        .event-item.red-card { background-color: #f8d7da; }
        .event-item.yellow-card { background-color: #fff3cd; }
        .event-item.substitution { background-color: #d1ecf1; }
        
        .event-icon {
            font-size: 1.5em;
            color: var(--primary-color);
        }

        .event-text {
            flex-grow: 1;
        }

        .tab-container {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            color: var(--text-color);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 8px;
        }

        .tab-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }
        
        .upcoming-match-card {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .upcoming-match-card .match-header {
            justify-content: space-between;
        }

        .upcoming-match-card .match-details {
            justify-content: space-between;
        }

        .admin-only-btn {
            background: #FF5722;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .admin-only-btn:hover {
            background: #E64A19;
            transform: scale(1.05);
        }

        .form-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .form-group input, .form-group select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #D1D9E6;
            background-color: white;
            color: var(--text-color);
            font-size: 16px;
        }
        
        .form-group select option {
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .match-stats-card {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .stats-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            font-size: 1em;
            padding: 10px 20px;
        }
        
        /* Contenedor de eventos por equipo */
        .event-modal-teams {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 20px;
        }
        
        .event-team-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .event-team-column h4 {
            margin: 0;
            text-align: center;
            color: var(--primary-color);
        }
        
        .event-modal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #F0F2F5;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .event-modal-item-icon {
            font-size: 1.2em;
            color: var(--secondary-color);
        }
        
        .match-event-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .player-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .player-input-group input {
            flex: 1;
        }
        
        .player-input-group .btn {
            padding: 8px 12px;
        }
        
        /* Estilos para los selectores de los eventos */
        .form-event-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: #F0F2F5;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .form-event-group label {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .form-event-group input, .form-event-group select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #D1D9E6;
            background-color: white;
        }
        
        /* Nueva clase para los eventos avanzados */
        .advanced-event-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .nav-btn span {
                display: none;
            }
        }
        
        /* Estilos para el estado de partido suspendido */
        .suspended-status {
            color: #dc3545;
            font-weight: 700;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <button class="nav-btn active" data-section="inicio"><i class="fas fa-home"></i> <span>Inicio</span></button>
            <button class="nav-btn" data-section="fechas"><i class="fas fa-calendar-alt"></i> <span>Fechas</span></button>
            <button class="nav-btn" data-section="partidos"><i class="fas fa-trophy"></i> <span>Partidos</span></button>
            <button class="nav-btn" data-section="admin"><i class="fas fa-user-shield"></i> <span>Admin</span></button>
        </nav>
        <main id="app-content">
            <!-- Sección de Inicio -->
            <section id="inicio" class="section">
                <div class="section-header">
                    <h2>Partidos en Vivo</h2>
                    <i class="fas fa-futbol" style="font-size: 2em; color: var(--accent-color);"></i>
                </div>
                <!-- Contenedor de eventos del partido para usuarios generales -->
                <div id="live-match-events-container" style="display: none;">
                    <h3>Eventos del Partido</h3>
                    <div id="live-event-log" class="event-log">
                        <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">No hay eventos de partido disponibles.</p>
                    </div>
                </div>
                <div id="live-matches-container">
                    <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">Cargando partidos en vivo...</p>
                </div>
            </section>
            <!-- Sección de Fechas -->
            <section id="fechas" class="section" style="display:none;">
                <div class="section-header">
                    <h2>Partidos Agendados</h2>
                    <i class="fas fa-calendar-plus" style="font-size: 2em; color: var(--accent-color);"></i>
                </div>
                <div class="tab-container">
                    <button class="tab-btn active" data-tab="Fechas">Fechas</button>
                    <button class="tab-btn" data-tab="Torneos">Torneos</button>
                    <button class="tab-btn" data-tab="Copa Juvenil">Copa Juvenil</button>
                </div>
                <div id="upcoming-matches-container">
                    <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">Cargando partidos agendados...</p>
                </div>
            </section>
            <!-- Sección de Partidos Finalizados -->
            <section id="partidos" class="section" style="display:none;">
                <div class="section-header">
                    <h2>Partidos Finalizados</h2>
                    <i class="fas fa-check-circle" style="font-size: 2em; color: var(--accent-color);"></i>
                </div>
                <div id="finished-matches-container">
                    <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">Cargando partidos finalizados...</p>
                </div>
            </section>
            <!-- Sección de Admin -->
            <section id="admin" class="section" style="display:none;">
                <div class="section-header">
                    <h2>Administración</h2>
                    <i class="fas fa-tools" style="font-size: 2em; color: var(--accent-color);"></i>
                </div>
                <div id="login-form" class="login-form">
                    <input type="password" id="admin-password" placeholder="Contraseña de Admin">
                    <button id="admin-login-btn" class="btn">Acceder</button>
                </div>
                <div id="admin-panel" style="display:none;">
                    <h3>Crear Nuevo Partido</h3>
                    <div class="form-container">
                        <div class="form-group">
                            <label for="team1-name-input">Nombre del Equipo 1:</label>
                            <input type="text" id="team1-name-input" placeholder="Ej: Real Madrid">
                        </div>
                        <div class="form-group">
                            <label for="team2-name-input">Nombre del Equipo 2:</label>
                            <input type="text" id="team2-name-input" placeholder="Ej: Barcelona">
                        </div>
                        <div class="form-group">
                            <label for="team1-shield-input">Escudo Equipo 1 URL:</label>
                            <input type="text" id="team1-shield-input" placeholder="URL del escudo">
                        </div>
                        <div class="form-group">
                            <label for="team2-shield-input">Escudo Equipo 2 URL:</label>
                            <input type="text" id="team2-shield-input" placeholder="URL del escudo">
                        </div>
                        <div class="form-group">
                            <label for="date-input">Fecha:</label>
                            <input type="date" id="date-input">
                        </div>
                        <div class="form-group">
                            <label for="time-input">Hora:</label>
                            <input type="time" id="time-input">
                        </div>
                        <div class="form-group">
                            <label for="stadium-input">Estadio:</label>
                            <input type="text" id="stadium-input" placeholder="Ej: Camp Nou">
                        </div>
                        <div class="form-group">
                            <label for="tournament-input">Torneo:</label>
                            <input type="text" id="tournament-input" placeholder="Ej: Liga B17">
                        </div>
                        <div class="form-group">
                            <label for="section-select">Sección:</label>
                            <select id="section-select">
                                <option value="Fechas">Fechas</option>
                                <option value="Torneos">Torneos</option>
                                <option value="Copa Juvenil">Copa Juvenil</option>
                            </select>
                        </div>
                        <button id="create-match-btn" class="btn">Crear Partido</button>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Partidos Agendados</h3>
                    <div id="admin-matches-list">
                        <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">Cargando partidos...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modales de la aplicación -->
    <div id="message-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mensaje</h3>
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-close-btn" class="btn red">Cerrar</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirmar</h3>
            <p id="confirm-message"></p>
            <div class="modal-buttons">
                <button id="confirm-cancel-btn" class="btn">Cancelar</button>
                <button id="confirm-accept-btn" class="btn red">Aceptar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Control de Partido en Vivo (ADMIN) -->
    <div id="live-admin-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Control de Partido</h3>
            <p id="live-admin-match-info" style="text-align: center; font-size: 1.1em; font-weight: 600;"></p>
            <div class="match-event-panel">
                <div class="form-event-group">
                    <label for="event-player">Seleccionar Jugador:</label>
                    <select id="event-player">
                        <option value="">Selecciona un jugador</option>
                    </select>
                    <div class="player-input-group">
                        <input type="text" id="player-custom-input" placeholder="Nombre de Jugador">
                        <button id="add-player-btn" class="btn" style="background: var(--secondary-color);">Añadir</button>
                    </div>
                </div>
                
                <div class="form-event-group">
                    <label for="event-type">Tipo de Evento:</label>
                    <select id="event-type">
                        <option value="goal">Gol</option>
                        <option value="yellow-card">Tarjeta Amarilla</option>
                        <option value="red-card">Tarjeta Roja</option>
                        <option value="substitution">Sustitución</option>
                    </select>
                    <div id="event-details-container">
                        <!-- Detalles de eventos dinámicos aquí -->
                    </div>
                    <button id="add-event-btn" class="btn" style="background: var(--secondary-color);">Registrar Evento</button>
                </div>

                <div class="form-event-group" id="suspend-reason-group" style="display: none;">
                    <label for="suspend-reason-input">Motivo de la suspensión:</label>
                    <input type="text" id="suspend-reason-input" placeholder="Ej: Falta de luz">
                </div>

                <div class="match-control-btns" style="display: flex; gap: 10px;">
                    <button id="suspend-match-btn" class="btn" style="flex: 1;">Suspender Partido</button>
                    <button id="resume-match-btn" class="btn" style="flex: 1; display: none;">Reanudar Partido</button>
                    <button id="end-match-btn" class="btn red" style="flex: 1;">Finalizar Partido</button>
                </div>
            </div>
            <div id="live-event-log-admin" class="event-log" style="max-height: 250px; margin-top: 20px;">
                <p style="text-align: center; color: rgba(0, 0, 0, 0.5);">Eventos del partido aparecerán aquí.</p>
            </div>
            <div class="modal-buttons" style="justify-content: center;">
                <button id="live-admin-close-btn" class="btn red">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Eventos de Partido para Usuarios -->
    <div id="events-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Eventos del Partido</h3>
            <p id="events-modal-match-info" style="text-align: center; font-weight: 600;"></p>
            <div id="events-modal-log" class="event-log" style="max-height: 400px;">
            </div>
            <div class="modal-buttons" style="justify-content: center;">
                <button id="events-modal-close-btn" class="btn red">Cerrar</button>
            </div>
        </div>
    </div>
    
    <div class="spinner" id="main-spinner"></div>

    <script type="module">
        // Importar los módulos necesarios de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Mover la inicialización de variables al inicio del script para asegurar su disponibilidad
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAdmin = false;
        let isSuspended = false;

        const ADMIN_PASSWORD = "admin"; // Contraseña de administrador

        // Referencias a elementos del DOM
        const appContent = document.getElementById('app-content');
        const navButtons = document.querySelectorAll('.nav-btn');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const loginForm = document.getElementById('login-form');
        const adminPanel = document.getElementById('admin-panel');
        const mainSpinner = document.getElementById('main-spinner');

        // Referencias a Modales
        const messageModal = document.getElementById('message-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const liveAdminModal = document.getElementById('live-admin-modal');
        const eventsModal = document.getElementById('events-modal');

        /**
         * Initializes Firebase app and handles authentication.
         */
        async function initializeFirebase() {
            try {
                // Initialize Firebase app
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                console.log("User authenticated with UID:", userId);
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showMessage("Error de Inicialización", "No se pudo conectar a la base de datos. Por favor, revisa la configuración.");
            }
        }

        /**
         * Muestra el spinner de carga.
         */
        function showSpinner() {
            mainSpinner.style.display = 'block';
        }

        /**
         * Oculta el spinner de carga.
         */
        function hideSpinner() {
            mainSpinner.style.display = 'none';
        }

        /**
         * Muestra un modal de mensaje.
         * @param {string} title Título del modal.
         * @param {string} message Mensaje a mostrar.
         */
        function showMessage(title, message) {
            document.getElementById('modal-message').innerText = message;
            messageModal.style.display = 'flex';
        }
        
        /**
         * Muestra un modal por su ID.
         * @param {string} modalId ID del modal.
         */
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        /**
         * Oculta un modal por su ID.
         * @param {string} modalId ID del modal.
         */
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        /**
         * Muestra un modal de confirmación.
         * @param {string} message Mensaje de confirmación.
         * @param {Function} onConfirm Callback a ejecutar si se confirma.
         */
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirm-message').innerText = message;
            const confirmBtn = document.getElementById('confirm-accept-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                hideModal('confirm-modal');
            });
            showModal('confirm-modal');
        }

        /**
         * Cambia la sección visible de la aplicación.
         * @param {string} sectionId ID de la sección a mostrar.
         */
        function changeSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';

            navButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-section="${sectionId}"]`).classList.add('active');
        }

        /**
         * Renderiza un partido en la lista.
         * @param {object} match Partido a renderizar.
         * @param {boolean} isAdminView Si es la vista de administrador.
         * @returns {string} HTML del partido.
         */
        function createMatchCard(match, isAdminView = false) {
            const date = new Date(match.date + 'T' + match.time);
            const status = match.isLive ? 'EN VIVO' : (match.isFinished ? 'FINALIZADO' : 'AGENDADO');
            const statusClass = match.isLive ? 'bg-green-500' : (match.isFinished ? 'bg-red-500' : 'bg-yellow-500');

            let buttonsHtml = '';
            if (isAdminView) {
                buttonsHtml += `<button class="admin-only-btn start-match-btn" data-id="${match.id}">Iniciar</button>`;
                buttonsHtml += `<button class="admin-only-btn end-match-btn" data-id="${match.id}" style="display:${match.isLive ? 'inline-block' : 'none'};">Finalizar</button>`;
                buttonsHtml += `<button class="admin-only-btn delete-match-btn" data-id="${match.id}">Eliminar</button>`;
                if (match.isLive) {
                    buttonsHtml += `<button class="admin-only-btn control-match-btn" data-id="${match.id}">Controlar</button>`;
                }
            } else {
                if (match.isLive) {
                    buttonsHtml += `<button class="btn view-events-btn" data-id="${match.id}">Ver Eventos</button>`;
                }
            }

            return `
                <div class="upcoming-match-card">
                    <div class="match-header">
                        <div class="team">
                            <img src="${match.team1Shield}" class="team-shield" alt="Escudo">
                            <span class="team-name">${match.team1Name}</span>
                        </div>
                        <span class="score-container">${match.score1} - ${match.score2}</span>
                        <div class="team">
                            <img src="${match.team2Shield}" class="team-shield" alt="Escudo">
                            <span class="team-name">${match.team2Name}</span>
                        </div>
                    </div>
                    <div class="match-details">
                        <p class="date"><i class="far fa-calendar-alt"></i> ${date.toLocaleDateString()} - ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                        <p class="section-name"><i class="fas fa-tag"></i> ${match.section}</p>
                    </div>
                    <div class="match-controls">
                        ${buttonsHtml}
                    </div>
                </div>
            `;
        }

        /**
         * Renderiza la lista de partidos en un contenedor.
         * @param {Array<object>} matches Partidos a renderizar.
         * @param {string} containerId ID del contenedor.
         * @param {boolean} isAdminView Si es la vista de administrador.
         */
        function renderMatches(matches, containerId, isAdminView = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = matches.length > 0 ? matches.map(m => createMatchCard(m, isAdminView)).join('') : '<p style="text-align: center; color: rgba(0, 0, 0, 0.5);">No hay partidos disponibles en este momento.</p>';
            
            // Re-attach event listeners
            if (isAdminView) {
                document.querySelectorAll('.start-match-btn').forEach(btn => btn.addEventListener('click', (e) => startMatch(e.target.dataset.id)));
                document.querySelectorAll('.delete-match-btn').forEach(btn => btn.addEventListener('click', (e) => deleteMatch(e.target.dataset.id)));
                document.querySelectorAll('.control-match-btn').forEach(btn => btn.addEventListener('click', (e) => showLiveAdminModal(e.target.dataset.id)));
                document.querySelectorAll('.end-match-btn').forEach(btn => btn.addEventListener('click', (e) => endMatch(e.target.dataset.id)));
            } else {
                document.querySelectorAll('.view-events-btn').forEach(btn => btn.addEventListener('click', (e) => showEventsModal(e.target.dataset.id)));
            }
        }
        
        /**
         * Sincroniza la vista del usuario con los datos de Firestore.
         */
        function syncUserView() {
            if (!db) return;
            // Listener para partidos en vivo
            onSnapshot(collection(db, `artifacts/${appId}/public/data/matches`), (snapshot) => {
                const liveMatches = [];
                const upcomingMatches = [];
                const finishedMatches = [];
                snapshot.docs.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (data.isLive && !data.isFinished) {
                        liveMatches.push(data);
                    } else if (data.isFinished) {
                        finishedMatches.push(data);
                    } else {
                        upcomingMatches.push(data);
                    }
                });
                renderMatches(liveMatches, 'live-matches-container');
                renderMatches(upcomingMatches, 'upcoming-matches-container');
                renderMatches(finishedMatches, 'finished-matches-container');
            }, (error) => {
                console.error("Error fetching matches:", error);
            });
        }
        
        /**
         * Sincroniza la vista del administrador con los datos de Firestore.
         */
        function syncAdminView() {
            if (!db) return;
            onSnapshot(collection(db, `artifacts/${appId}/public/data/matches`), (snapshot) => {
                const matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMatches(matches, 'admin-matches-list', true);
            }, (error) => {
                console.error("Error fetching matches for admin:", error);
            });
        }

        /**
         * Inicia un partido.
         * @param {string} matchId ID del partido.
         */
        async function startMatch(matchId) {
            showConfirmModal('¿Estás seguro de que quieres iniciar este partido?', async () => {
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/matches`, matchId), { isLive: true });
                    showMessage('Éxito', 'Partido iniciado. Ahora está en vivo.');
                } catch (e) {
                    console.error("Error starting match: ", e);
                    showMessage('Error', 'No se pudo iniciar el partido. Inténtalo de nuevo.');
                }
            });
        }

        /**
         * Finaliza un partido.
         * @param {string} matchId ID del partido.
         */
        async function endMatch(matchId) {
            showConfirmModal('¿Estás seguro de que quieres finalizar este partido?', async () => {
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/matches`, matchId), { isLive: false, isFinished: true });
                    showMessage('Éxito', 'Partido finalizado.');
                } catch (e) {
                    console.error("Error ending match: ", e);
                    showMessage('Error', 'No se pudo finalizar el partido. Inténtalo de nuevo.');
                }
            });
        }
        
        /**
         * Elimina un partido.
         * @param {string} matchId ID del partido.
         */
        async function deleteMatch(matchId) {
            showConfirmModal('¿Estás seguro de que quieres eliminar este partido? Esta acción es irreversible.', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/matches`, matchId));
                    showMessage('Éxito', 'Partido eliminado.');
                } catch (e) {
                    console.error("Error deleting match: ", e);
                    showMessage('Error', 'No se pudo eliminar el partido. Inténtalo de nuevo.');
                }
            });
        }

        /**
         * Muestra el modal de control para el administrador.
         * @param {string} matchId ID del partido.
         */
        async function showLiveAdminModal(matchId) {
            const docRef = doc(db, `artifacts/${appId}/public/data/matches`, matchId);
            onSnapshot(docRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const matchData = docSnap.data();
                    if (!matchData.isLive) {
                        hideModal('live-admin-modal');
                        showMessage('Información', 'Este partido ya no está en vivo.');
                        return;
                    }
                    
                    document.getElementById('live-admin-match-info').innerText = `${matchData.team1Name} ${matchData.score1} - ${matchData.score2} ${matchData.team2Name}`;
                    
                    const eventLog = document.getElementById('live-event-log-admin');
                    eventLog.innerHTML = matchData.events && matchData.events.length > 0 ? matchData.events.map(event => `<div class="event-item">${event.text}</div>`).join('') : '<p style="text-align: center; color: rgba(0, 0, 0, 0.5);">No hay eventos registrados.</p>';
                    
                    document.getElementById('add-event-btn').onclick = () => addMatchEvent(matchId);
                    document.getElementById('end-match-btn').onclick = () => endMatch(matchId);
                    
                    // Lógica para suspender/reanudar
                    document.getElementById('suspend-reason-group').style.display = isSuspended ? 'block' : 'none';
                    document.getElementById('suspend-match-btn').style.display = isSuspended ? 'none' : 'block';
                    document.getElementById('resume-match-btn').style.display = isSuspended ? 'block' : 'none';
                    
                    showModal('live-admin-modal');
                } else {
                    hideModal('live-admin-modal');
                }
            });
        }
        
        /**
         * Muestra el modal de eventos para usuarios.
         * @param {string} matchId ID del partido.
         */
        async function showEventsModal(matchId) {
            const docRef = doc(db, `artifacts/${appId}/public/data/matches`, matchId);
            onSnapshot(docRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const matchData = docSnap.data();
                    document.getElementById('events-modal-match-info').innerText = `${matchData.team1Name} vs ${matchData.team2Name}`;
                    
                    const eventLog = document.getElementById('events-modal-log');
                    eventLog.innerHTML = matchData.events && matchData.events.length > 0 ? matchData.events.map(event => `<div class="event-item">${event.text}</div>`).join('') : '<p style="text-align: center; color: rgba(0, 0, 0, 0.5);">No hay eventos registrados.</p>';
                    
                    showModal('events-modal');
                } else {
                    hideModal('events-modal');
                }
            });
        }
        
        /**
         * Añade un evento al partido.
         * @param {string} matchId ID del partido.
         */
        async function addMatchEvent(matchId) {
            const eventType = document.getElementById('event-type').value;
            const eventPlayer = document.getElementById('player-custom-input').value || document.getElementById('event-player').value;
            
            if (!eventPlayer) {
                showMessage('Error', 'Por favor, ingresa un jugador o selecciona uno.');
                return;
            }
            
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/matches`, matchId);
                const matchDoc = await getDoc(docRef);
                
                if (matchDoc.exists()) {
                    const matchData = matchDoc.data();
                    const newEvent = {
                        type: eventType,
                        player: eventPlayer,
                        timestamp: Date.now()
                    };
                    
                    let updatedEvents = matchData.events || [];
                    updatedEvents.push(newEvent);
                    
                    await updateDoc(docRef, { events: updatedEvents });
                }
            } catch (e) {
                console.error("Error adding event:", e);
                showMessage('Error', 'No se pudo añadir el evento.');
            }
        }
        
        // Listeners de eventos
        window.addEventListener('load', async () => {
            showSpinner();
            await initializeFirebase();
            hideSpinner();
            syncUserView();

            // Navegación
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const sectionId = btn.dataset.section;
                    changeSection(sectionId);
                    if (sectionId === 'admin') {
                        loginForm.style.display = 'block';
                        adminPanel.style.display = 'none';
                    }
                });
            });

            // Tabs en Fechas
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabButtons.forEach(tab => tab.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            // Login de administrador
            document.getElementById('admin-login-btn').addEventListener('click', () => {
                const password = document.getElementById('admin-password').value;
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    loginForm.style.display = 'none';
                    adminPanel.style.display = 'block';
                    syncAdminView();
                    showMessage('Éxito', 'Acceso de administrador concedido.');
                } else {
                    showMessage('Error', 'Contraseña incorrecta.');
                }
            });
            
            // Creación de partido
            document.getElementById('create-match-btn').addEventListener('click', async () => {
                const team1Name = document.getElementById('team1-name-input').value;
                const team2Name = document.getElementById('team2-name-input').value;
                const team1Shield = document.getElementById('team1-shield-input').value;
                const team2Shield = document.getElementById('team2-shield-input').value;
                const date = document.getElementById('date-input').value;
                const time = document.getElementById('time-input').value;
                const stadium = document.getElementById('stadium-input').value;
                const tournament = document.getElementById('tournament-input').value;
                const section = document.getElementById('section-select').value;
                
                if (!team1Name || !team2Name || !date || !time || !stadium || !tournament || !section) {
                    showMessage('Error', 'Por favor, completa todos los campos.');
                    return;
                }
                
                const matchData = {
                    team1Name,
                    team2Name,
                    team1Shield,
                    team2Shield,
                    date,
                    time,
                    stadium,
                    tournament,
                    section,
                    isLive: false,
                    isFinished: false,
                    score1: 0,
                    score2: 0,
                    events: [],
                    timestamp: Date.now()
                };
                
                showSpinner();
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/matches`), matchData);
                    showMessage('Éxito', 'Partido creado con éxito.');
                } catch (e) {
                    console.error("Error creating match:", e);
                    showMessage('Error', 'No se pudo crear el partido. Inténtalo de nuevo.');
                } finally {
                    hideSpinner();
                }
            });
            
            // Cerrar modales
            document.getElementById('modal-close-btn').addEventListener('click', () => hideModal('message-modal'));
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => hideModal('confirm-modal'));
            document.getElementById('live-admin-close-btn').addEventListener('click', () => hideModal('live-admin-modal'));
            document.getElementById('events-modal-close-btn').addEventListener('click', () => hideModal('events-modal'));

            // Lógica de suspender/reanudar
            document.getElementById('suspend-match-btn').addEventListener('click', async () => {
                const reasonInput = document.getElementById('suspend-reason-input');
                reasonInput.style.display = 'block';
                document.getElementById('suspend-match-btn').style.display = 'none';
                document.getElementById('resume-match-btn').style.display = 'block';
            });
            
            document.getElementById('resume-match-btn').addEventListener('click', async () => {
                const reasonInput = document.getElementById('suspend-reason-input');
                reasonInput.style.display = 'none';
                document.getElementById('suspend-match-btn').style.display = 'block';
                document.getElementById('resume-match-btn').style.display = 'none';
            });
        });

    </script>
</body>
</html>
